<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <h2 style="text-align:center; margin-top: 20px;">กำลังบันทึกข้อมูล...</h2>

    <script>
        // *** 1. ใส่ค่า LIFF ID ของคุณตรงนี้ ***
const MY_LIFF_ID = "2008522992-erYZ1bAd";
        // *** 2. ใส่ Web App URL ที่ได้จากส่วนที่ 1 ตรงนี้ ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9CHYRmgKQHLiGUnZoa2vnTHfjX1du1tsyaHNFmlkrUxLE_B-zvXMFfQkOaMUG4xsT/exec";

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // ดึงข้อมูล Profile
                const profile = await liff.getProfile();
                
                // ดึงค่า UTM จาก URL Link
                const urlParams = new URLSearchParams(window.location.search);
                const utm_source = urlParams.get('utm_source');
                const utm_channel = urlParams.get('utm_channel');

                // เตรียมข้อมูลส่งไป Google Sheet
                const dataToSend = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    utm_source: utm_source,
                    utm_channel: utm_channel
                };

                // ส่งข้อมูลด้วย fetch
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // สำคัญสำหรับการส่งข้ามโดเมนไป Google Script
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });

                // ทำงานเสร็จแล้ว ปิดหน้าต่าง LIFF หรือ Redirect ไป Add Friend
                // liff.closeWindow();  // ถ้าต้องการให้ปิดเลย
                
                // แนะนำ: Redirect ไปหน้าเพิ่มเพื่อน หรือหน้า Landing Page
                window.location.replace("https://line.me/R/ti/p/@giftwise"); 

            } catch (err) {
                console.error(err);
                alert("เกิดข้อผิดพลาด: " + err);
            }
        }

        main();
    </script>
</body>
</html>